version: "3.8"

services:
  nginx-proxy:
    image: nginxproxy/nginx-proxy:1.5
    container_name: orcazap-nginx-proxy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./data/nginx/certs:/etc/nginx/certs:rw
      - ./data/nginx/vhost.d:/etc/nginx/vhost.d:rw
      - ./data/nginx/html:/usr/share/nginx/html:rw
      - /var/run/docker.sock:/tmp/docker.sock:ro
    networks:
      - proxy

  acme-companion:
    image: nginxproxy/acme-companion:2.2
    container_name: orcazap-acme
    restart: unless-stopped
    environment:
      DEFAULT_EMAIL: contato@orcazap.net
      NGINX_PROXY_CONTAINER: orcazap-nginx-proxy
    volumes:
      - ./data/nginx/certs:/etc/nginx/certs:rw
      - ./data/nginx/vhost.d:/etc/nginx/vhost.d:rw
      - ./data/nginx/html:/usr/share/nginx/html:rw
      - ./data/nginx/acme:/etc/acme.sh:rw
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - nginx-proxy
    networks:
      - proxy

  backend:
    build: ./backend
    container_name: orcazap-backend
    restart: unless-stopped
    environment:
      PORT: "3000"
      JWT_SECRET: "orcazap-0c7c13d0a7f24f4ea0b7c4c0a3a8c7e2"
      DB_PATH: "/app/data/orcamentos.db"
      MP_ACCESS_TOKEN: "${MP_ACCESS_TOKEN}"
      EVOLUTION_URL: "${EVOLUTION_URL}"
      EVOLUTION_INSTANCE: "${EVOLUTION_INSTANCE}"
      EVOLUTION_APIKEY: "${EVOLUTION_APIKEY}"
      FRONTEND_URL: "https://orcazap.net"
    volumes:
      - ./data/app:/app/data
      - ./data/uploads:/app/uploads
    networks:
      - proxy

  frontend:
    build:
      context: ./frontend
      args:
        VITE_MP_PUBLIC_KEY: "${VITE_MP_PUBLIC_KEY}"
    container_name: orcazap-frontend
    restart: unless-stopped
    environment:
      VIRTUAL_HOST: orcazap.net,www.orcazap.net
      LETSENCRYPT_HOST: orcazap.net,www.orcazap.net
      LETSENCRYPT_EMAIL: contato@orcazap.net
      VIRTUAL_PORT: "80"
      HTTPS_METHOD: "noredirect"
    depends_on:
      - backend
    networks:
      - proxy

networks:
  proxy:
    name: orcazap-proxy
